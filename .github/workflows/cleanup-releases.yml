name: Cleanup Old Releases

on:
  workflow_call:
    inputs:
      days-to-keep:
        required: false
        default: '90'
        type: string
      min-releases-to-keep:
        required: false
        default: '5'
        type: string
    secrets:
      GH_TOKEN:
        required: true

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cleanup script
        uses: actions/checkout@v4

      - name: Run cleanup inline
        run: |
          pip install PyGithub
          python3 - <<'EOF'
          import os
          import argparse
          import warnings
          from datetime import datetime, timedelta, timezone
          from github import Github

          warnings.filterwarnings("ignore", category=DeprecationWarning)

          parser = argparse.ArgumentParser()
          parser.add_argument('--days', type=int, default=90)
          parser.add_argument('--keep', type=int, default=5)
          args = parser.parse_args()

          token = os.environ["GITHUB_TOKEN"]
          repo_name = os.environ["GITHUB_REPOSITORY"]

          g = Github(token)
          repo = g.get_repo(repo_name)
          releases = list(repo.get_releases())
          releases.sort(key=lambda r: r.created_at, reverse=True)

          cutoff = datetime.now(timezone.utc) - timedelta(days=args.days)

          print(f"🧹 Total releases found: {len(releases)}")
          print(f"🛡️ Keeping the {args.keep} most recent releases, regardless of age.")
          print(f"🕒 Deleting any older than: {cutoff.isoformat()}")

          to_delete = []
          for idx, release in enumerate(releases):
              if idx < args.keep:
                  print(f"✅ KEEP (recent): {release.title} ({release.tag_name})")
                  continue
              if release.created_at >= cutoff:
                  print(f"✅ KEEP (fresh):  {release.title} ({release.tag_name})")
                  continue
              print(f"🗑️ DELETE: {release.title} ({release.tag_name})")
              to_delete.append(release)

          print(f"🔎 Total to delete: {len(to_delete)}")
          for release in to_delete:
              release.delete_release()
              try:
                  ref = repo.get_git_ref(f"tags/{release.tag_name}")
                  ref.delete()
                  print(f"🗑️ Deleted tag: {release.tag_name}")
              except Exception:
                  print(f"⚠️ Tag not found or already deleted: {release.tag_name}")
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

